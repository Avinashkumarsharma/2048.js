(function(){var e,n,r,s,o,u,a,f,l,c,h,p,d,v;window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame;var m=function(e,t,n,i,s){if(n<2*s)s=n/2;if(i<2*s)s=i/2;this.beginPath();this.moveTo(e+s,t);this.arcTo(e+n,t,e+n,t+i,s);this.arcTo(e+n,t+i,e,t+i,s);this.arcTo(e,t+i,e,t,s);this.arcTo(e,t,e+n,t,s);this.closePath();r.lineWidth=3;return this};var g=function(e,t){for(key in e){if(t&&t[key])e[key]=t[key]}return e};var b=function(e,t){var n=t;var r=n.length;for(var i=0;i<r;i++){for(var s=0;s<r-i-1;s++){switch(e){case"L":if(n[s+1].y<n[s].y||n[s].y==n[s+1].y&&n[s+1].x<n[s].x){var o=n[s];n[s]=n[s+1];n[s+1]=o}break;case"R":if(n[s+1].y<n[s].y||n[s].y==n[s+1].y&&n[s+1].x>n[s].x){var o=n[s];n[s]=n[s+1];n[s+1]=o}break;case"D":if(n[s+1].x<n[s].x||n[s].x==n[s+1].x&&n[s+1].y>n[s].y){var o=n[s];n[s]=n[s+1];n[s+1]=o}break;case"U":if(n[s+1].x<n[s].x||n[s].x==n[s+1].x&&n[s+1].y<n[s].y){var o=n[s];n[s]=n[s+1];n[s+1]=o}break}}}return n};var w=function(t){var n={};n["Multiplier"]={2:"2",4:"4",8:"8",16:"16",32:"32",64:"64",128:"128",256:"256",512:"512",1024:"1024",2048:"2048"};n["Tile"]={2:["#eee4da","#776e65"],4:["#ede0c8","#776e65"],8:["#f2b179","#f9f6f2"],16:["#f59563","#f9f6f2"],32:["#f67c5f","#f9f6f2"],64:["#f65e3b","#f9f6f2"],128:["#edcf72","#f9f6f2"],256:["#edcc61","#f9f6f2"],512:["#edc850","#f9f6f2"],1024:["#f9d769","#f9f6f2"],2048:["#f1b43d","#f9f6f2"]};n["Background"]="#bbada0";n["Forground"]="#ccc0b3";n["Size"]=4;n["Dimension"]=500;if(t){for(key in n){if(t[key]&&t)n[key]=t[key]}}e=n};window.__2048__=w;var E=function(){o=e["Size"];u="";a=e["Dimension"];c=false;d=0;s=[];f=[];if(newgame=document.getElementById("__2048__newgame"));newgame.addEventListener("click",_,false);n=document.createElement("canvas");if(!n.getContext){alert("canvas not supported by browser, Update it !");return}CanvasRenderingContext2D.prototype.roundRect=m;n.id="canvas";n.width=n.height=e["Dimension"];r=n.getContext("2d");S();if(!localStorage){alert("Sorry you have to play without saving, or you can update browser")}if(localStorage["boardRestore"]){L()}else _();document.addEventListener("keydown",q,false)};w.prototype.init=E;var S=function(){var t=e["Dimension"];r.fillStyle=e["Background"];var s=6/500*n.width;r.clearRect(0,0,n.width,n.height);r.roundRect(0,0,n.width,n.height,s).fill();var o=107/500*t;var u=15/500*t;r.fillStyle=e["Forground"];_x=0;_y=0;for(i=0;i<e["Size"];i++){for(j=0;j<e["Size"];j++){r.roundRect(_x+u,_y+u,o,o,s/2).fill();_x+=u+o}_y+=u+o;_x=0}document.getElementById("__2048__").appendChild(n)};var T=function(t){var n={background:"#eee4da",color:"#776e65",digit:2,x:4,y:4,dx:4,dy:4};n=g(n,t);this.background=n.background;this.color=n.color;this.digit=n.digit;this.x=n.x;this.y=n.y;this.size=107/500*e["Dimension"];this.radius=3/107*this.size;this._x=this.size*(this.x-1)+e["Dimension"]*(15/500)*this.x;this._y=this.size*(this.y-1)+e["Dimension"]*(15/500)*this.y;this.content=e["Multiplier"][this.digit];this.dx=this.x;this.dy=this.y;this.merge=false;this.drawTile=N;this.clearTile=C;this.appear=P;this.updatePosition=B};var N=function(){var t=this._x;var n=this._y;var i=e["Tile"][this.digit][1];background=e["Tile"][this.digit][0];r.fillStyle=background;r.roundRect(t,n,this.size,this.size,this.radius).fill();r.fillStyle=i;var s=(60-((this.content+"").length-1)*10)*(this.size/107);r.font="normal 800 "+s+"px Clear sans, Myriad Pro, sans-serif";var o=r.measureText(this.content);_x=t+this.size/2-o.width/2;_y=n+this.size/2+1/3*s;r.fillText(this.content,_x,_y);return this};var C=function(){t=new T({x:this.x,y:this.y});r.fillStyle=e["Background"];x=this._x;y=this._y;r.fillRect(this._x-9/500*e["Dimension"],this._y-9/500*e["Dimension"],this.size+20/500*e["Dimension"],this.size+20/500*e["Dimension"])};var k=function(e){var t=e,n={},r="",i=[];for(var s in t){r=t[s].x+""+t[s].y;n[r]=t[s].digit}for(var s=1;s<=o;s++){for(var u=1;u<=o;u++){r=u+""+s;if(!n[r])i.push({x:u,y:s})}}return i};var L=function(){S();f=[];var e,t;v=parseInt(localStorage["highscore"]);var n=localStorage.getItem("boardRestore");var r=n.split("|");r.pop();for(key in r){e=JSON.parse(r[key]);t=new T({x:e.x,y:e.y,digit:e.digit});s.push(t)}for(key in s)s[key].drawTile();f=k(s);d=parseInt(localStorage["score"]);O()};var A=function(){var e="",t;for(key in s){t={x:s[key].x,y:s[key].y,digit:s[key].digit};e+=JSON.stringify(t)+"|"}localStorage.removeItem("boardRestore");localStorage.setItem("boardRestore",e);localStorage.setItem("score",d)};var O=function(e){document.getElementById("__2048__score").innerHTML=d;if(v<d){localStorage.setItem("highscore",d);v=d}document.getElementById("__2048__highscore").innerHTML=v;if(localStorage)A()};var M=function(e){var t=e,n={},r="",i;var s,o,u,a;i=k(t);for(var f in t){if(t.digit==2048)return-1}if(i.length)return true;for(var f in t){r=t[f].x+""+t[f].y;n[r]=t[f].digit}for(var f in t){s=t[f].x-1+""+t[f].y;o=t[f].x+1+""+t[f].y;a=t[f].x+""+(t[f].y+1);u=t[f].x+""+(t[f].y-1);if(n[s]&&n[s]==t[f].digit||n[o]&&n[o]==t[f].digit||n[a]&&n[a]==t[f].digit||n[u]&&n[u]==t[f].digit)return true}return false};var _=function(){d=0;S();f=[];localStorage.removeItem("boardRestore");localStorage.setItem("score",0);localStorage.setItem("time",0);for(var e=1;e<=o;e++){for(var t=0;t<=o;t++){f.push({x:t,y:e})}}s=[];D();setTimeout(D,400);document.addEventListener("keydown",q,false);if(!localStorage["highscore"]){v=0;localStorage.setItem("highscore",v)}O()};window.__2048__.prototype.newGame=_;var D=function(t){f=k(s);var n;if(f.length==0){return false}var r=Math.ceil(Math.random()*f.length-1);if(f.length==1)r=0;var i=f.splice(r,1).pop();n=new T(i);s.push(n);n.size=10;n._x+=(107/500*e["Dimension"]-n.size)/2;n._y+=(107/500*e["Dimension"]-n.size)/2;n.appear()};var P=function(){var t=this;var n=1.8;var r=107/500*e["Dimension"];this._x-=(this.size*n-this.size)/2;this._y-=(this.size*n-this.size)/2;this.size*=n;if(this.size>r){this.size=r;this._x=this.size*(this.x-1)+e["Dimension"]*(15/500)*this.x;this._y=this.size*(this.y-1)+e["Dimension"]*.03*this.y;this.drawTile();window.cancelAnimationFrame(l);l=undefined;document.addEventListener("keydown",q,false);var i=M(s);if(i==-1)alert("You Won!");if(!i)alert("Game Over, Try again");O();return}this.drawTile();l=requestAnimationFrame(function(){t.appear()})};var H=function(e,t,n){var r=b(n,t);var i,u,a,f;u=f=o;i=a=1;for(var l in r){switch(n){case"R":if(e.y!=r[l].y){r[l].dx=u;e=r[l];continue}else if(!e.merge&&e.digit==r[l].digit){r[l].dx=e.dx;r[l].merge=true;e=r[l];d+=r[l].digit*2}else{r[l].dx=e.dx-1;e=r[l]}break;case"L":if(e.y!=r[l].y){r[l].dx=i;e=r[l];continue}else if(!e.merge&&e.digit==r[l].digit){r[l].dx=e.dx;r[l].merge=true;e=r[l];d+=r[l].digit*2}else{r[l].dx=e.dx+1;e=r[l]}break;case"U":if(e.x!=r[l].x){r[l].dy=a;e=r[l];continue}else if(!e.merge&&e.digit==r[l].digit){r[l].dy=e.dy;r[l].merge=true;e=r[l];d+=r[l].digit*2}else{r[l].dy=e.dy+1;e=r[l]}break;case"D":if(e.x!=r[l].x){r[l].dy=f;e=r[l];continue}else if(!e.merge&&e.digit==r[l].digit){r[l].dy=e.dy;r[l].merge=true;e=r[l];d+=r[l].digit*2}else{r[l].dy=e.dy-1;e=r[l]}break}}s=r;if(M(s))I()};var B=function(e){var t,n,r,i;t=.8;i=this.size*(o-1)+a*(15/500)*o;switch(u){case"R":t=(i-this._x)*(1-t);n=this.size*(this.dx-1)+a*(15/500)*this.dx;if(this.dx==this.x&&!this.merge)return 1;if(this._x+t>=n-this.size/2){c=true;this.x=this.dx;this._x=n;if(this.merge){c=true;this.merge=false;this.digit*=2;this.content*=2;s.splice(e-1,1)}}else{this._x+=t;c=true;return 0}break;case"L":n=this.size*(this.dx-1)+a*(15/500)*this.dx;if(this.dx==this.x&&!this.merge)return 1;if(this._x*t<=n+this.size/1.5){c=true;this.x=this.dx;this._x=n;if(this.merge){this.merge=false;this.digit*=2;this.content*=2;s.splice(e-1,1)}}else{this._x*=t;c=true;return 0}break;case"U":r=this.size*(this.dy-1)+a*(15/500)*this.dy;if(this.dy==this.y&&!this.merge)return 1;if(this._y*t<=r+this.size/1.5){c=true;this.y=this.dy;this._y=r;if(this.merge){this.merge=false;this.digit*=2;this.content*=2;s.splice(e-1,1)}}else{this._y*=t;c=true;return 0}break;case"D":t=(i-this._y)*(1-t);r=this.size*(this.dy-1)+a*(15/500)*this.dy;if(this.dy==this.y&&!this.merge)return 1;if(this._y+t>=r-this.size/2){c=true;this.y=this.dy;this._y=r;if(this.merge){this.merge=false;this.digit*=2;this.content*=2;s.splice(e-1,1)}}else{this._y+=t;c=true;return 0}break}};var F;var I=function(){var e=0;for(var t in s){if(s[t].merge){e+=s[t].updatePosition(t);t--}else{e+=s[t].updatePosition(t)}}if(e==s.length){window.cancelAnimationFrame(F);F=undefined;if(M(s)&&c){D();c=false}else{document.addEventListener("keydown",q,false)}return}S();for(var t in s)s[t].drawTile();F=window.requestAnimationFrame(I)};var q=function(e){document.removeEventListener("keydown",q,false);switch(e.keyCode){case 37:u="L";H({x:0,y:0,digit:0,dx:0,dy:0},s,"L");break;case 38:u="U";H({x:0,y:0,digit:0,dx:0,dy:0},s,"U");break;case 39:u="R";H({x:0,y:0,digit:0,dx:0,dy:0},s,"R");break;case 40:u="D";H({x:0,y:0,digit:0,dx:0,dy:0},s,"D");break}}})()